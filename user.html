<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Cart - User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; }
    .navbar { background: linear-gradient(90deg, #007bff, #00c6ff); }
    .navbar-brand { color: white !important; font-weight: 600; }
    .btn-remove { background: #ff4d4d; border-radius: 6px; color: white; border: none; padding: 4px 10px; }
    .btn-remove:hover { background: #d80000; }
    .total-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<nav class="navbar px-3">
  <a class="navbar-brand" href="#">üõçÔ∏è My Smart Cart</a>
</nav>

<div class="container my-4">
  <h3>Your Items</h3>
  <table class="table table-striped">
    <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th></th></tr></thead>
    <tbody id="cartTable"></tbody>
  </table>

  <div class="total-box">
    <h4>Total: ‚Çπ<span id="totalPrice">0.00</span></h4>
  </div>
</div>

<script>
const THINGER_BUCKET_URL = "https://api.thinger.io/v2/users/yash7642/buckets/cart_events/data";
const THINGER_TOKEN = "YOUR_TOKEN";
const cartId = "demo_cart_1"; // Your cart ID

let cartData = {};
let removedItemIds = {};

// ‚úÖ Shared real-time communication channel
const syncChannel = new BroadcastChannel("cart_sync_channel");

function broadcastUpdate() {
  syncChannel.postMessage({ type: "update_removed_items" });
}

syncChannel.onmessage = () => {
  loadRemovedItems();
  fetchCartData();
};

function loadRemovedItems() {
  const saved = localStorage.getItem("admin_removed_items");
  removedItemIds = saved ? JSON.parse(saved) : {};
}

function saveRemovedItems() {
  localStorage.setItem("admin_removed_items", JSON.stringify(removedItemIds));
}

async function fetchCartData() {
  const res = await axios.get(THINGER_BUCKET_URL, { headers: { Authorization: "Bearer " + THINGER_TOKEN } });
  const items = res.data.filter(e => e.cartId === cartId);

  cartData = {};

  items.forEach(item => {
    const id = item._id || item.eventId;
    if (removedItemIds[cartId]?.includes(id)) return;

    if (!cartData[item.item]) {
      cartData[item.item] = { price: item.price, qty: 1, ids: [id] };
    } else {
      cartData[item.item].qty++;
      cartData[item.item].ids.push(id);
    }
  });

  renderCart();
}

function renderCart() {
  const table = document.getElementById("cartTable");
  table.innerHTML = "";

  let total = 0;
  Object.keys(cartData).forEach(name => {
    const item = cartData[name];
    const sum = item.price * item.qty;
    total += sum;

    table.innerHTML += `
      <tr>
        <td>${name}</td><td>‚Çπ${item.price.toFixed(2)}</td>
        <td>${item.qty}</td><td>‚Çπ${sum.toFixed(2)}</td>
        <td><button class="btn-remove" onclick="removeItem('${name}')">‚ùå</button></td>
      </tr>`;
  });

  document.getElementById("totalPrice").innerText = total.toFixed(2);
}

function removeItem(name) {
  const id = cartData[name].ids[0];
  if (!removedItemIds[cartId]) removedItemIds[cartId] = [];
  removedItemIds[cartId].push(id);
  saveRemovedItems();
  broadcastUpdate(); // ‚úÖ Sync to admin
  fetchCartData();
}

loadRemovedItems();
setInterval(fetchCartData, 5000);
fetchCartData();
</script>

</body>
</html>
