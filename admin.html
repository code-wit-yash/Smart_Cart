<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõí Smart Cart - Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; }
    .navbar { background: linear-gradient(90deg, #007bff, #00c6ff); }
    .navbar-brand { color: white !important; font-weight: 600; }
    .accordion-button:not(.collapsed) { background-color: #007bff; color: white; }
    .btn-remove, .btn-checkout, .btn-clear-all { border-radius: 8px; color: white; border: none; padding: 5px 10px; cursor: pointer; transition: 0.3s; }
    .btn-remove { background: #ff4d4d; }
    .btn-remove:hover { background: #e60000; }
    .btn-checkout { background: #28a745; margin-right: 10px; }
    .btn-checkout:hover { background: #1e7e34; }
    .btn-clear-all { background: #6c757d; }
    .btn-clear-all:hover { background: #5a6268; }
    .alerts { color: red; font-weight: 600; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">üõí Smart Cart - Admin</a>
    </div>
  </nav>

  <div class="container my-5">
    <h3 class="mb-4">All Carts</h3>
    <button class="btn btn-clear-all mb-3" onclick="clearAllRemovedItems()">üóëÔ∏è Clear All Removed Items History</button>
    <div class="accordion" id="cartsAccordion"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const THINGER_BUCKET_URL = "https://api.thinger.io/v2/users/yash7642/buckets/cart_events/data";
const THINGER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJyZWFkX2NhcnQiLCJzdnIiOiJldS1jZW50cmFsLmF3cy50aGluZ2VyLmlvIiwidXNyIjoieWFzaDc2NDIifQ.lGO_NX7ctPtObLJToP4lJnvw9nC6yxejVQFy7FJ5Yo4";

let allCartData = {};
let openCartId = null;

// ‚úÖ Shared removed item memory
let removedItemIds = {};

// ‚úÖ BroadcastChannel for live sync between User ‚Üî Admin
const syncChannel = new BroadcastChannel("cart_sync_channel");
function broadcastUpdate() {
  syncChannel.postMessage({ type: "update_removed_items" });
}
syncChannel.onmessage = (e) => {
  if (e.data.type === "update_removed_items") {
    loadRemovedItems();
    fetchAllCarts();
  }
};

// ‚úÖ Load Removed Items from Storage
function loadRemovedItems() {
  const stored = localStorage.getItem('admin_removed_items');
  removedItemIds = stored ? JSON.parse(stored) : {};
  Object.keys(removedItemIds).forEach(id => removedItemIds[id] = new Set(removedItemIds[id]));
}

// ‚úÖ Save Removed Items to Storage
function saveRemovedItems() {
  const obj = {};
  Object.keys(removedItemIds).forEach(id => obj[id] = [...removedItemIds[id]]);
  localStorage.setItem('admin_removed_items', JSON.stringify(obj));
}

function clearAllRemovedItems() {
  if (!confirm("Clear removal history for ALL carts?")) return;
  removedItemIds = {};
  localStorage.removeItem('admin_removed_items');
  broadcastUpdate();
  fetchAllCarts();
}

// ‚úÖ Fetch Live Cart Data
async function fetchAllCarts() {
  try {
    const res = await axios.get(THINGER_BUCKET_URL, { headers: { Authorization: "Bearer " + THINGER_TOKEN } });
    const raw = res.data;
    const carts = {};

    raw.forEach(ev => {
      const cartId = ev.cartId;
      const itemId = ev._id || ev.eventId;
      if (!carts[cartId]) carts[cartId] = {};
      if (ev.action === "REMOVED") return;
      if (removedItemIds[cartId] && removedItemIds[cartId].has(itemId)) return;

      if (!carts[cartId][ev.item]) {
        carts[cartId][ev.item] = { name: ev.item, price: ev.price, qty: 0, ids: [], time: new Date(ev.timestamp).toLocaleTimeString(), scanned: ev.action !== "UNKNOWN" };
      }
      carts[cartId][ev.item].qty++;
      carts[cartId][ev.item].ids.push(itemId);
    });

    if (JSON.stringify(carts) !== JSON.stringify(allCartData)) {
      allCartData = carts;
      renderCarts();
    }
  } catch (err) { console.error(err); }
}

// ‚úÖ Render UI
function renderCarts() {
  const acc = document.getElementById("cartsAccordion");
  acc.innerHTML = "";

  Object.keys(allCartData).forEach((cartId, idx) => {
    const items = Object.values(allCartData[cartId]);
    const total = items.reduce((s, i) => s + i.price * i.qty, 0);
    const flag = items.some(i => !i.scanned) ? "‚ùó Unscanned Item" : "";

    acc.innerHTML += `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button ${cartId === openCartId ? '' : 'collapsed'}"
            data-bs-toggle="collapse" data-bs-target="#cart${idx}" onclick="openCartId='${cartId}'">
            Cart: ${cartId} | Total: ‚Çπ${total.toFixed(2)} <span class="alerts">${flag}</span>
          </button>
        </h2>
        <div id="cart${idx}" class="accordion-collapse collapse ${cartId === openCartId ? 'show' : ''}">
          <div class="accordion-body">
            <table class="table align-middle">
              <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th>Time</th><th>Scan</th><th>Action</th></tr></thead>
              <tbody>
                ${items.map(i => `
                <tr>
                  <td>${i.name}</td>
                  <td>‚Çπ${i.price}</td>
                  <td>${i.qty}</td>
                  <td>‚Çπ${(i.price * i.qty).toFixed(2)}</td>
                  <td>${i.time}</td>
                  <td>${i.scanned ? "‚úÖ" : "‚ùå"}</td>
                  <td><button class="btn-remove" onclick="removeItem('${cartId}', '${i.name}')">‚ùå</button></td>
                </tr>`).join('')}
              </tbody>
            </table>
            <button class="btn-checkout" onclick="checkoutCart('${cartId}')">‚úÖ Checkout</button>
            <button class="btn-clear-all" onclick="clearCartRemovedItems('${cartId}')">üóëÔ∏è Clear Removed</button>
          </div>
        </div>
      </div>`;
  });
}

// ‚úÖ Remove 1 item
function removeItem(cartId, itemName) {
  const item = allCartData[cartId][itemName];
  const id = item.ids[0];
  if (!removedItemIds[cartId]) removedItemIds[cartId] = new Set();
  removedItemIds[cartId].add(id);
  saveRemovedItems();
  broadcastUpdate();
  fetchAllCarts();
}

// ‚úÖ Checkout entire cart
function checkoutCart(cartId) {
  if (!confirm(`Checkout cart ${cartId}?`)) return;
  if (!removedItemIds[cartId]) removedItemIds[cartId] = new Set();
  Object.values(allCartData[cartId]).forEach(i => i.ids.forEach(id => removedItemIds[cartId].add(id)));
  saveRemovedItems();
  broadcastUpdate();
  fetchAllCarts();
}

// ‚úÖ Clear removed items for one cart
function clearCartRemovedItems(cartId) {
  delete removedItemIds[cartId];
  saveRemovedItems();
  broadcastUpdate();
  fetchAllCarts();
}

loadRemovedItems();
fetchAllCarts();
setInterval(fetchAllCarts, 5000);
</script>
</body>
</html>
