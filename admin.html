<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Cart - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="p-4">

<h2>Admin Cart View</h2>
<div id="carts"></div>

<script>
const THINGER_BUCKET_URL = "https://api.thinger.io/v2/users/yash7642/buckets/cart_events/data";
const THINGER_TOKEN = "YOUR_TOKEN";

let allCarts = {};
let removedItemIds = {};

// ✅ Shared Chat Channel
const syncChannel = new BroadcastChannel("cart_sync_channel");

function broadcastUpdate() {
  syncChannel.postMessage({ type: "update_removed_items" });
}

syncChannel.onmessage = () => {
  loadRemovedItems();
  fetchAllCarts();
};

function loadRemovedItems() {
  const saved = localStorage.getItem("admin_removed_items");
  removedItemIds = saved ? JSON.parse(saved) : {};
}

function saveRemovedItems() {
  localStorage.setItem("admin_removed_items", JSON.stringify(removedItemIds));
  broadcastUpdate();
}

async function fetchAllCarts() {
  const res = await axios.get(THINGER_BUCKET_URL, { headers: { Authorization: "Bearer " + THINGER_TOKEN } });

  const data = res.data;
  const carts = {};

  data.forEach(event => {
    const id = event._id || event.eventId;
    if (!carts[event.cartId]) carts[event.cartId] = {};
    if (removedItemIds[event.cartId]?.includes(id)) return;

    if (!carts[event.cartId][event.item]) {
      carts[event.cartId][event.item] = { price: event.price, qty: 1, ids: [id] };
    } else {
      carts[event.cartId][event.item].qty++;
      carts[event.cartId][event.item].ids.push(id);
    }
  });

  allCarts = carts;
  renderCarts();
}

function renderCarts() {
  const container = document.getElementById("carts");
  container.innerHTML = "";

  Object.keys(allCarts).forEach(cartId => {
    const items = allCarts[cartId];

    container.innerHTML += `<h4>Cart: ${cartId}</h4>`;
    Object.keys(items).forEach(name => {
      const item = items[name];
      container.innerHTML += `
        ${name} - ₹${item.price} × ${item.qty}
        <button onclick="removeItem('${cartId}','${name}')">❌ Remove</button>
        <br>`;
    });

    container.innerHTML += `<hr>`;
  });
}

function removeItem(cartId, itemName) {
  const id = allCarts[cartId][itemName].ids[0];
  if (!removedItemIds[cartId]) removedItemIds[cartId] = [];
  removedItemIds[cartId].push(id);
  saveRemovedItems();
  fetchAllCarts();
}

loadRemovedItems();
setInterval(fetchAllCarts, 5000);
fetchAllCarts();
</script>

</body>
</html>
